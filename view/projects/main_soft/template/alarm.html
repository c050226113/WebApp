<style>
    #alarm_vue .main {padding: 3% 3%;height: 85%;overflow: auto;}
    #alarm_vue .receive table{color: white;height: 80px;}
    #alarm_vue .send table{color: white;}
    #alarm_vue .head{border-radius: 50%;}
    #alarm_vue .receive .head{float: left;}
    #alarm_vue .send .head{float: right;}
    #alarm_vue .receive .table{border-top-right-radius:0.7em;border-bottom-right-radius:0.7em;border-bottom-left-radius:0.7em;margin-top: 20px;margin-left: 8px;background-color: #CDD7E2;float: left;}
    #alarm_vue .send .table{border-top-left-radius:0.7em;border-bottom-right-radius:0.7em;border-bottom-left-radius:0.7em;margin-top: 20px;margin-right: 8px;background-color: #78CDF8;float: right;}
    #alarm_vue .receive .name{position: absolute;margin-left: 9px;font-size: 10px;}
    #alarm_vue .send .name{right: 0;position: absolute;margin-right: 5px;font-size: 10px;top: -18px;}
    #alarm_vue .receive td.w60{padding-left: 20px;}
    #alarm_vue .receive .time{color: #ffffff;position: absolute;margin-top: 0;margin-left: 80%;top: 60px;}
    #alarm_vue .send .time{color: #ffffff;position: absolute;margin-top: 0;margin-left: 80%;top: 66%;}
    #alarm_vue .receive .name{position: absolute;margin-left: 1px;font-size: 10px;top: -18px;}
    #alarm_vue .head{width:15%;display: block}
    #alarm_vue .span_time{background-color: #bbb;font-size: 10px;padding: 3px 9px;border-radius: 5px;color: #fff;}
    #alarm_vue #alarm_message{height: 45px;background-color: #fff;padding: 5px;border-top: #ddd solid 1px;}
    #alarm_vue #alarm_message input{width: 80%;height: 100%;background-color: #fff;margin-right: 3%;}
    #alarm_vue #alarm_message button{width: 16%;}
    #alarm_vue td.a{padding: 10px 20px;}
    #alarm_vue span.time.a{margin-top: -4px;}
    #alarm_vue table.talk td {color:#000}
    #alarm_vue .send td{word-break: break-all;  padding: 13px 14px;}
</style>
<section id="alarm_vue">
    <table class="navigation mh">
        <tr>
            <td onclick="history.go(-1)"><img data-src="./img/back.svg">返回</td>
            <td>安全警报</td>
            <td></td>
        </tr>
    </table>
    <div class="main">
        <div class="item {{ item.isrecieve? 'receive':'send' }}" v-for="item in events_[launcher_vue.using]">
            <template v-if="item.isrecieve">
                <img class="head fl" :title="item.date" :src="babyHeadImg?babyHeadImg:'img/nodata.svg'" />
                <div class="table w60 pos_r fl">
                    <span class="name">{{name}}</span>
                    <table class="w100 talk">
                        <tr>
                            <td class="w40"><img :title="item.type" class="w70 fr" src="img/event-{{item.type}}.svg" /></td>
                            <td class="w60">{{item.message}}</td>
                        </tr>
                    </table>
                    <span class="time">{{item.time}}</span>
                </div>
                <div class="cb"></div>
            </template>
            <template v-else>
                <img class="head" :title="item.date" :src="userHeadImg?userHeadImg:'img/nodata.svg'" />
                <div class="table w60 pos_r">
                    <span class="name">我</span>
                    <table class="w100 talk">
                        <tr>
                            <td class="w100 event-{{item.type}}"><img @click="notice()" :class="(item.status)? 'disn':''" style="height: 10%;left: -43px;position: relative;" src="img/notice.svg">{{item.message}}</td>
                        </tr>
                    </table>
                    <span class="time {{item.type}}">{{item.time}}</span>
                </div>
                <div class="cb"></div>
            </template>
        </div>
    </div>
    <div id="alarm_message" class="w100 pos_a b0">
        <input class="fl showKeyboard" v-model="sendValue" />
        <button class="btn btn-primary" @click="send()">发送</button>
    </div>
</section>
<script>
    var alarm_vue = function(){
        alarm_vue = new Vue({
            el: '#alarm_vue',
            created: function () {
                this.launcher_vue = launcher_vue;
            },
            compiled: function () {
                this.initData();
                launcher_vue.makeSureHeight(this.$el);
            },
            data: {
                dayago:3,
                lastTime:'',
                events_:{},
                sendValue:'',
                roleArr:[
                    {name:'爸爸'},
                    {name:'妈妈'},
                    {name:'爷爷'},
                    {name:'奶奶'},
                    {name:'外公'},
                    {name:'外婆'},
                    {name:'叔叔'},
                    {name:'阿姨'},
                    {name:'哥哥'},
                    {name:'姐姐'}
                ]
            },
            computed: {
                events:{
                    get:function(){
                        return this.events_[launcher_vue.using];
                    },
                    set:function(val){
                        this.events_[launcher_vue.using] = val;
                        this.events_ = JSON.parse(JSON.stringify(this.events_));
                        var dayGroup = {};
                        for(var i=0;i<this.events_[launcher_vue.using].length;i++){
                            var item = this.events_[launcher_vue.using][i];
                            var date = item.date;
                            if(!dayGroup[date]){
                                dayGroup[date] = date;
                            }
                        }
                        this.addDate(dayGroup);
                    }
                },
                name:{
                    get:function(){
                        return launcher_vue.devices[launcher_vue.using][DEVICE_INFO][DEVICE_NAME];
                    }
                },
                babyHeadImg:{
                    get:function(){
                        if(launcher_vue.devices[launcher_vue.using][DEVICE_INFO][DEVICE_AVT].length>11){
                            return launcher_vue.devices[launcher_vue.using][DEVICE_INFO][DEVICE_AVT];
                        }else{
                            return '';
                        }
                    }
                },
                userHeadImg:{
                    get:function(){
                        if(launcher_vue.useravt.length>11){
                            return launcher_vue.useravt;
                        }else{
                            return '';
                        }
                    }
                }
            },
            methods: {
                init:function(){
                    this.initData();
                },
                initView:function(){
                    $(this.$el).find(".span_time").remove();
                },
                initData:function(){
                    var self = this;
                    try{
                        if(this.events_[launcher_vue.using]){
                            if(!$(this.$el).find(".span_time").length){
                                self.events = self.events;
                            }
                        }else{
                            throw new SQLException;
                        }
                    }catch (err){
                        var lastDay = 3;
                        var dataStr = '{' +
                                '"'+KEY+'":"'+ lastDay +'",' +
                                '"sessionId":"'+app.sessionId+'"' +
                                '}';
                        $.ajax({type: 'post', url: app.API_URL+'?r=main_soft/get_events', data: Helper.getJsonObj(dataStr), dataType: 'json',
                            success: function (data) {
                                self.events_[launcher_vue.using] = [];
                                if (data[CODE] != 0) {
                                    return false;
                                } else {
                                    self.events_[launcher_vue.using] = Helper.getJsonObj(data[MESSAGE]);
                                    self.drawEvents(self.events_[launcher_vue.using]);
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                console.log(errorThrown);
                                index_vue.logout();
                            }
                        });
                    }
                },
                drawEvents:function(arr){
                    var events = [];
                    for(var i=0;i<arr.length;i++){
                        var eventObj = arr[i];
                        var time = eventObj[DEVICE_EVENT_INTTIME]*1000;
                        var dateObj = new Date(time);
                        var content = '';
                        switch (eventObj[DEVICE_EVENT_TYPE]){
                            case DEVICE_EVENT_TYPE_SOS:
                                switch(eventObj[DEVICE_EVENT_MESSAGE]){
                                    case DEVICE_EVENT_TYPE_SOS_BTN:
                                        content = '按键报警';
                                        break;
                                    case DEVICE_EVENT_TYPE_SOS_FALL:
                                        content = '跌落报警';
                                        break;
                                    case DEVICE_EVENT_TYPE_SOS_HEART_RATE:
                                        content = '心率报警';
                                        break;
                                    case DEVICE_EVENT_TYPE_SOS_SIGN:
                                        content = '签到';
                                        break;
                                }
                                break;
                            case DEVICE_EVENT_TYPE_MESSAGE:
                                content = eventObj[DEVICE_EVENT_MESSAGE];
                                break;
                        }
                        var event = {
                            date:'i'+dateObj.getFullYear()+(dateObj.getMonth()+1)+dateObj.getDate(),
                            time:dateObj.getHours().addZ() + ':' + dateObj.getMinutes().addZ(),
                            isrecieve:eventObj[DEVICE_EVENT_ISRECIEVE],
                            message:content,
                            type:eventObj[DEVICE_EVENT_TYPE]
                        };
                        events.push(event);
                    }
                    this.events = events;
                },
                scrollToBottom:function(){
                    var $obj = $(this.$el);
                    setTimeout(function(){
                        $obj.find('.main').scrollTop(10000);//滚动到底部
                    },50);
                },
                addDate:function(dayGroup){
                    var $obj = $(this.$el);
                    var self = this;
                    setTimeout(function(){
                        var dateObj = new Date();
                        var today = dateObj.getFullYear()+''+(dateObj.getMonth()+1)+''+dateObj.getDate()+'';
                        $obj.find('.main .head').each(function(index,obj){
                            var key = $(this).attr('title');
                            if(dayGroup[key]){
                                var content;
                                if(key == 'i'+today){
                                    content = '今天';
                                }else{
                                    content = key.substr(5,2)+'月'+key.substr(7,2)+'日';
                                }

                                $('.date'+key).remove();
                                $(obj).parent().before('<div class="txtc"><span class="span_time date'+key+'">'+content+'</span></div>');
                                dayGroup[key] = '';
                            }
                        });
                        self.scrollToBottom();
                    },1);
                },
                send:function(){
                    var self = this;
                    if(!this.sendValue){
                        Message.toast('发送内容不能为空!',2);
                        return false;
                    }

                    var isrecieve = 0;//发送
                    var dataStr = '{' +
                            '"'+MESSAGE+'":"'+ this.sendValue +'",' +
                            '"'+TYPE+'":"'+ DEVICE_EVENT_TYPE_MESSAGE +'",' +
                            '"'+FACE+'":"'+ isrecieve +'",' +
                            '"sessionId":"'+app.sessionId+'"' +
                            '}';
                    $.ajax({type: 'post', url: app.API_URL+'?r=main_soft/add_event', data: Helper.getJsonObj(dataStr), dataType: 'json',
                        success: function (data) {
                            if (data[CODE] == 1) {

                                Message.toast(data[MESSAGE], 2);
                                return false;

                            } else {
                                var status = 0;
                                if(data[CODE] == 101){
                                    Message.toast('设备不在线', 2);
                                }else{
                                    status = 1;
                                }

                                //更新ui
                                if(data[MESSAGE]){
                                    var time = parseInt(data[MESSAGE])*1000;
                                    var dateObj = new Date(time);
                                    var event = {
                                        status:status,
                                        date:'i'+dateObj.getFullYear()+(dateObj.getMonth()+1)+dateObj.getDate(),
                                        time:dateObj.getHours() + ':' + dateObj.getMinutes(),
                                        //+ ":" + dateObj.getSeconds(),
                                        isrecieve:isrecieve, type:DEVICE_EVENT_TYPE_MESSAGE, message:self.sendValue
                                    };
                                    var eventArr = self.events;
                                    eventArr.push(event);
                                    self.events = eventArr;
                                    self.sendValue = '';
                                }
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(errorThrown);
                            index_vue.logout();
                        }
                    });
                },
                notice:function(){
                    Message.toast('当前设备不在线，当设备上线时会自动推送至设备上',3);
                }
            }
        });
    };




</script>